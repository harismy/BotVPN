#!/bin/bash
dpkg-statoverride --remove /var/spool/exim4
dpkg --configure -a
apt -f install -y
mv /var/lib/dpkg/statoverride /var/lib/dpkg/statoverride.old
touch /var/lib/dpkg/statoverride

# Colors
green="\e[38;5;82m"
red="\e[38;5;196m"
neutral="\e[0m"
orange="\e[38;5;130m"
blue="\e[38;5;39m"
yellow="\e[38;5;226m"
purple="\e[38;5;141m"
bold_white="\e[1;37m"
reset="\e[0m"
pink="\e[38;5;205m"

# Fungsi gradient ungu → aqua
print_rainbow() {
    local text="$1"
    local length=${#text}
    local start_color=(128 0 128)    # Ungu
    local end_color=(0 255 255)      # Aqua
    for ((i=0;i<length;i++)); do
        local factor=$(echo "scale=2; $i/($length-1)" | bc)
        r=$(echo "scale=0; (${start_color[0]}*(1-$factor)+${end_color[0]}*$factor)/1" | bc)
        g=$(echo "scale=0; (${start_color[1]}*(1-$factor)+${end_color[1]}*$factor)/1" | bc)
        b=$(echo "scale=0; (${start_color[2]}*(1-$factor)+${end_color[2]}*$factor)/1" | bc)
        printf "\e[38;2;%d;%d;%dm%s" "$r" "$g" "$b" "${text:$i:1}"
    done
    echo -e "$reset"
}

cek_status() {
    pm2 status | grep -q sellvpn && echo "aktif" || echo "nonaktif"
}

setup_bot() {
    timedatectl set-timezone Asia/Jakarta || echo -e "${red}Failed to set timezone${neutral}"

    if ! dpkg -s nodejs >/dev/null 2>&1; then
        curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
        apt-get install -y nodejs
    fi

    rm -rf /root/BotVPN
    git clone https://github.com/harismy/BotVPN.git /root/BotVPN

    npm install -g npm@latest pm2
    npm install --prefix /root/BotVPN sqlite3 express crypto telegraf axios dotenv
    chmod +x /root/BotVPN/*
}

server_app() {
    clear
    echo -e "${orange}╔════════════════════════════════════════╗${neutral}"
    print_rainbow "      BOT SELLVPN TELEGRAM SERVER      "
    echo -e "${orange}╚════════════════════════════════════════╝${neutral}"
    echo -e "${purple}•${neutral} server create user"
    echo -e "${purple}•${neutral} server renew user"
    echo -e "${purple}•${neutral} server lock user"
    echo -e "${purple}•${neutral} server unlock user"
    echo -e "${purple}•${neutral} server delete user"
    echo -e "${purple}•${neutral} server addressel user"
    echo -e "${purple}•${neutral} server addsaldo user"
    echo -e "${purple}•${neutral} server ceksaldo user"
    echo -e "${orange}─────────────────────────────────────────${neutral}"

    # Input dengan border keren
    for field in "Masukkan token bot" "Masukkan admin ID" "Masukkan nama store" "Masukkan DATA QRIS" "Masukkan ID GROUP NOTIF"; do
        while true; do
            echo -e "${blue}╭─[INPUT]─╮${neutral}"
            read -p "$field: " value
            echo -e "${blue}╰─────────╯${neutral}"
            if [ -n "$value" ]; then
                case $field in
                    "Masukkan token bot") token="$value" ;;
                    "Masukkan admin ID") adminid="$value" ;;
                    "Masukkan nama store") namastore="$value" ;;
                    "Masukkan DATA QRIS") dataqris="$value" ;;
                    "Masukkan ID GROUP NOTIF") groupid="$value" ;;
                esac
                break
            else
                echo -e "${red}Input tidak boleh kosong, coba lagi!${neutral}"
            fi
        done
    done

    merchantid="NONE"
    apikey="NONE"
    rm -f /root/BotVPN/.vars.json
    echo "{
  \"BOT_TOKEN\": \"$token\",
  \"USER_ID\": \"$adminid\",
  \"NAMA_STORE\": \"$namastore\",
  \"GROUP_ID\": \"$groupid\",
  \"PORT\": \"6969\",
  \"DATA_QRIS\": \"$dataqris\",
  \"MERCHANT_ID\": \"$merchantid\",
  \"API_KEY\": \"$apikey\"
}" >/root/BotVPN/.vars.json

    cd /root/BotVPN
    pm2 start ecosystem.config.js
    pm2 startup
    pm2 save
    cd
    service cron restart
    echo -e "${green}Bot has been installed and running!${neutral}"
    echo -e "${green}Type /start or menu in the Telegram bot${neutral}"
}

if [[ ${1} == "sellvpn" ]]; then
    setup_bot
    server_app
else
    echo -e "${red}Invalid command. Use: start sellvpn${neutral}"
    exit 1
fi
